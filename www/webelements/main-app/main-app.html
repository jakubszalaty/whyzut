<!-- webelements -->
<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">

<link rel="import" href="../../bower_components/app-layout/app-drawer-layout/app-drawer-layout.html">
<link rel="import" href="../../bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="../../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../../bower_components/app-layout/app-toolbar/app-toolbar.html">

<link rel="import" href="../../bower_components/app-route/app-route.html">
<link rel="import" href="../../bower_components/app-route/app-location.html">

<link rel="import" href="../../bower_components/neon-animation/neon-animated-pages.html">

<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">

<link rel="import" href="../../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="../../bower_components/paper-menu/paper-menu.html">

<link rel="import" href="../../bower_components/paper-date-picker/paper-date-picker.html">

<link rel="import" href="../../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../../bower_components/iron-swipeable-pages/iron-swipeable-pages.html">

<link rel="import" href="../../bower_components/paper-progress/paper-progress.html">

<!-- <link rel="import" href="../../bower_components/app-layout/app-scrollpos-control/app-scrollpos-control.html"> -->

<!-- custom elements -->
<link rel="import" href="../app-login-form/app-login-form.html">
<link rel="import" href="../paper-card-repeater/paper-card-repeater.html">
<link rel="import" href="../iron-swipeable-page/iron-swipeable-page.html">

<dom-module id="main-app">

  <template>
    <style is="custom-style">
      .content {
        background-color: #eee;
        height: auto;
        padding: 8px;
        min-height: calc(100vh - 64px);
        position: relative;
      }
      .content paper-card{
        margin-bottom: 8px;
      }
      .content paper-card:last-child{
        margin-bottom: 0px;
      }

      .setting-content{
        padding: 0 8px;
      }
    </style>


    <style>


      app-header {
        background-color: var(--paper-indigo-500);
        color: #fff;
      }

      app-header paper-icon-button {
        --paper-icon-button-ink-color: white;
      }

      .drawer-container{
        /*height: 182px;*/
      }
      .last-check{
        font-size: 12px;
      }
      .yellow-button {
        text-transform: none;
        color: #eeff41;
        position: absolute;
        right: 0;
        top: 8px;
      }

      paper-date-picker{
        margin: 0 auto;
        position: relative;
      }
      @media (max-width: 520px) {
        paper-date-picker{
          left: calc(50% - 164px);
        }
      }

      paper-date-picker{
        --paper-date-picker-heading: {
          display: none!important;
        }
      }

      #datePickerOuter{
        transition: height 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        height: 0px;
        overflow: hidden;
        background-color: #FFF;
        position: absolute;
        z-index: 10;
        will-change: height;
      }

      #mainPages.shadow {
        overflow: hidden;
      }
      #mainPages.shadow:after {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: #000;
        opacity: 0.4;
        z-index: 8;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        will-change: all;
    }
    #swipePages{
      min-height: calc(100vh - 64px);
    }
    #swipePages.disabled-anim > *{
      transition: none!important;
    }
    #progressBar{
      display: block;
      width: 100%;
      height: 3px;
    }

    </style>

    <iron-localstorage
      name="userInfo"
      value="{{user}}"
      on-iron-localstorage-load-empty="initializeDefaultUserInfo"
      ></iron-localstorage>



    <app-location use-hash-as-path route="{{route}}"></app-location>
    <app-route
      route="{{route}}"
      pattern="/:page"
      data="{{routeData}}"
      tail="{{subroute}}">
  </app-route>

  <paper-toast class="fit-bottom" id="updatedData" duration="0" text="[[toastText]]">
    <paper-button onclick="updatedData.toggle()" class="yellow-button">Ok</paper-button>
  </paper-toast>

  <!-- <app-scrollpos-control selected="{{activeSelected}}"></app-scrollpos-control> -->
  <app-drawer-layout>

    <app-drawer id="drawer" swipe-open>
      <app-header-layout has-scrolling-region>

        <app-header fixed>
            <app-toolbar style="height: 128px;"></app-toolbar>

            <app-toolbar style="height: 64px;">
              <div class="drawer-container">
                <div class="info">
                  <div class="name">Witaj, {{user.name}}!</div>
                </div>
              </div>
            </app-toolbar>

        </app-header>

          <!-- nav menu -->
          <paper-listbox attr-for-selected="route" selected="{{route.path}}"  on-iron-activate="_drawerSelected">
            <paper-item route="/main" disabled="[[!user.logged]]">
              <paper-icon-button icon="list"></paper-icon-button>
              Plan
            </paper-item>
            <paper-item route="/settings">
              <paper-icon-button icon="settings"></paper-icon-button>
              Ustawienia
            </paper-item>
          </paper-listbox>

        </app-header-layout>
      </app-drawer>

      <app-header-layout>


        <app-header condenses effects="waterfall" fixed>
          <app-toolbar>
            <paper-icon-button icon="menu" drawer-toggle></paper-icon-button>
            <div main-title> [[title]]  </div>


            <div class="last-check" hidden$="[[!_isVisibleSchedule(user.logged,route.path)]]"> [[user.lastCheck]] </div>
            <paper-icon-button icon="refresh" hidden$="[[!_isVisibleSchedule(user.logged,route.path)]]" on-tap="_refreshData"></paper-icon-button>
            <paper-icon-button icon="today" hidden$="[[!_isVisibleSchedule(user.logged,route.path)]]" on-tap="_toggleDatapicker"></paper-icon-button>
          </app-toolbar>

          <paper-tabs sticky selected="{{activeSelected}}" hidden$="[[!_isVisibleSchedule(user.logged,route.path)]]">
            <paper-tab>Pon</paper-tab>
            <paper-tab>Wt</paper-tab>
            <paper-tab>Åšr</paper-tab>
            <paper-tab>Czw</paper-tab>
            <paper-tab>Pt</paper-tab>
            <paper-tab>Sb</paper-tab>
            <paper-tab>Nd</paper-tab>
          </paper-tabs>

          <paper-progress id="progressBar" indeterminate bottom-item hidden$="[[!lodingData]]"></paper-progress>



          <app-toolbar id="datePickerOuter">
            <paper-date-picker date={{currentDate}}></paper-date-picker>
          </app-toolbar>


        </app-header>


        <neon-animated-pages id="mainPages" attr-for-selected="route" selected="{{route.path}}">
          <div class="content" route="/main" style="padding:0;">


            <iron-swipeable-pages id="swipePages" no-cycle="true" selected="{{activeSelected}}">

              <iron-swipeable-page>
                <paper-card-repeater offset-start="0" range="isoweek" date="{{currentDate}}"></paper-card-repeater>
              </iron-swipeable-page>

              <iron-swipeable-page>
                <paper-card-repeater offset-start="1" range="isoweek" date="{{currentDate}}"></paper-card-repeater>
              </iron-swipeable-page>

              <iron-swipeable-page>
                <paper-card-repeater offset-start="2" range="isoweek" date="{{currentDate}}"></paper-card-repeater>
              </iron-swipeable-page>

              <iron-swipeable-page>
                <paper-card-repeater offset-start="3" range="isoweek" date="{{currentDate}}"></paper-card-repeater>
              </iron-swipeable-page>

              <iron-swipeable-page>
                <paper-card-repeater offset-start="4" range="isoweek" date="{{currentDate}}"></paper-card-repeater>
              </iron-swipeable-page>

              <iron-swipeable-page>
                <paper-card-repeater offset-start="5" range="isoweek" date="{{currentDate}}"></paper-card-repeater>
              </iron-swipeable-page>

              <iron-swipeable-page>
                <paper-card-repeater offset-start="6" range="isoweek" date="{{currentDate}}"></paper-card-repeater>
              </iron-swipeable-page>
            </iron-swipeable-pages>

          </div>

          <div class="content" route="/settings">

            <div class="setting-content">
              <app-login-form></app-login-form>
            </div>

          </div>

          <div class="content" route="/about">



          </div>

        </neon-animated-pages>

      </app-header-layout>

    </app-drawer-layout>

  </template>

  <script>

    Polymer({

      is: 'main-app',

      properties: {
        route: {
          type: Object
        },
        activeSelected: {
          type: Number,
          value: function(){
            return new Date().getDay()-1;
          }
        },
        range:{
          type: String,
          value: 'isoweek'
        },
        lodingData:{
          type: Boolean,
          value: false
        }
      },

      attached: function(){
        if(!this.user.logged)
          return this.set('route.path','/settings');

        if(!this.route.path)
          return this.set('route.path','/main');
      },

      observers: [
        '_routePathChanged(route.path)',
        '_dateChanged(currentDate)'
      ],

      _routePathChanged: function(path) {

        if (path == '/main') {
          this.set('title','Plan');
        }

        if (path == '/settings') {
          this.set('title','Ustawienia');
        }

      },
      _drawerSelected: function() {
        if (!this.$.drawer.persistent) this.$.drawer.close();
      },

      _refreshData: function() {
        app.updateUserData();
      },
      toastMsg: function(text){
        if(!text)
          return;
        this.set('toastText',text);
        this.$.updatedData.open();
      },
      _toggleDatapicker: function(){

        if(this.$.datePickerOuter.classList.toggle('open')){
          var height = this.$.datePickerOuter.querySelector('paper-date-picker').clientHeight;
          this.$.datePickerOuter.style.height = height + 'px';
          this.$.mainPages.classList.add('shadow');
        }else{
          this.$.datePickerOuter.style.height = "";
          this.$.mainPages.classList.remove('shadow');
        }
      },
      _dateChanged: function(){
        var self = this;
        if(self.$.datePickerOuter.classList.contains('open')){
          // -1 bo zwraca 1-7
          var weekDay = self.currentDate.getDay()-1;
          // wyjatek na niedziele

          if(weekDay==-1)
            weekDay=6;


          self.$.datePickerOuter.style.height = "";
          self.$.mainPages.classList.remove('shadow');
          self.$.swipePages.classList.add('disabled-anim');
          self.$.swipePages.select(weekDay);

          setTimeout(function(){
            self.$.swipePages.classList.remove('disabled-anim');
          },10);

        }
      },
      _isVisibleSchedule: function(logged, path){
        return (logged && path == '/main');
      },
      initializeDefaultUserInfo: function(){
        this.user = {
          name: "Niezalogowany",
          logged: false,
          lastCheck: null,
          // currentDate: new Date(),
          // activeSelected: new Date().getDay()-1
        };
      }
    });

  </script>

</dom-module>
